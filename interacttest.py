import json
from selenium import webdriver
from selenium.webdriver.support.wait import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.common.by import By
import logging
from concurrent.futures import ThreadPoolExecutor, wait, ALL_COMPLETED
from time import sleep
from urllib import parse
import sys
import traceback
import re
from difflib import get_close_matches

from decrypt import *

ANALYSE_ILLUST_THREADS: int = 10
WRITERAW_TO_DB_THREADS: int = 10
WRITE_TAGS_TO_DB_THREADS: int = 10
FETCH_TRANSLATED_TAG_THREADS: int = 10
WRITE_TRANSTAGS_TO_DB_THREADS: int = 10
TRANSTAG_RETURN_THREADS: int = 10
UID: str = '71963925'

CWD = os.getcwd()
SQLPATH = CWD + '\src\illdata.db'

logger = logging.getLogger('logger')

handler = logging.StreamHandler()

logger.setLevel(logging.DEBUG)
handler.setLevel(logging.DEBUG)

formatter = logging.Formatter("[%(asctime)s %(name)s %(thread)d %(funcName)s] %(levelname)s %(message)s")
handler.setFormatter(formatter)

logger.addHandler(handler)

map_result = {'一起一起这里那里': [63674882], 'Tsumiki Miniwa': [63674882], 'crepe': [63674882], 'あっちこっち100users入り': [63674882], '女孩子': [65303230, 83105924, 83379817, 89455468, 89940945, 97744623, 103085664, 103854857, 105681985, 105766640, 106009822, 106510956, 108868627, 109403472, 110407870, 110617751, 111774289, 111903995, 112043080, 112603909, 112706079, 112985310, 113073498, 113194644, 113382108, 113389072, 113827401, 113833851, 113866964, 113874156, 114140195, 114334547, 114358322, 114540270, 114623234, 114659963, 114719663, 114863840, 115034087, 115393059, 115795804, 116321773, 116362998, 117130134, 117717637, 118402334, 119006438, 119223830], ' 原创': [65303230, 83379817, 85054286, 85116042, 97744623, 103854857, 105681985, 105766640, 107429786, 109403472, 110407870, 110617751, 111903995, 111903995, 112603909, 112706079, 112985310, 113194644, 113328969, 113328969, 113382108, 113833851, 114334547, 114540270, 114863840, 115113274, 115113274, 115393059, 116362998, 117717637, 119006438], '车站': [65303230], '原创3000收藏': [65303230, 112660921], '塔什干': [79862254], '碧蓝航线': [79862254, 83117983, 101288368, 103085664, 110579259, 111774289, 112814707, 114256592, 115425149, 115555168, 115555168, 115652323, 115652323, 115654142, 115795804, 115798216, 115798216, 118839253], '塔什干（碧蓝航线）': [79862254], '插画': [79862254, 115113274], '鯛焼き': [79862254], '碧蓝航线10000收藏': [79862254], '金发碧眼': [83105924], 'negligee': [83105924], '仰卧': [83105924], '白色连衣裙': [83105924], '原创10000users加入书籤': [83105924, 97820948], '金色长发': [83105924, 89455468, 107429786], '蝴蝶结': [83105924], '视线': [83105924], 'Azur Lane': [83117983, 103085664, 111774289, 112814707, 114256592, 115654142, 118839253], '白裤袜': [83117983, 103085664, 103833240, 107427921, 113874156, 114256592, 115654142, 116321773], 'young girl': [83117983, 111774289, 116362998], '腿': [83117983], '野兽先辈': [83117983], '脚底': [83117983, 89455468, 115425149], 'little girl': [83117983], '恶毒（碧蓝航线）': [83117983], 'uniform': [83379817, 84450882, 97744623, 113328969, 113389072], '夏天': [83379817], ' 守れない、この笑顔': [83379817], 'reality is cruel': [83379817], 'dumb girl': [83379817], 'large breasts': [83379817, 117717637], 'sparkling eyes': [83379817, 114659963], '原创50000收藏': [83379817, 85054286], 'Rent-A-Girlfriend': [84450882, 84450882], '樱泽墨': [84450882], 'cat': [84450882, 89940945, 113073498], 'cat ears': [84450882, 86429742, 95295577, 103854857, 112985310, 113073498, 113194644, 113382108, 113827401, 114140195, 114623234, 114719663, 114863840], '白色过膝袜': [84450882, 105681985, 107429786, 113874156, 116362998], '拾ってください': [84450882], '租借女友5000收藏': [84450882], '白圣女与黑牧师': [85054286], '四つ耳': [85054286], '白皮肤': [85054286], '顎に手': [85054286], '白聖女と黒牧師50000users入り': [85054286], '塞西莉亚（白圣女与黑牧师）': [85054286], '兽耳': [85116042, 101288368, 103854857, 105766640, 108868627, 109875858, 111775230, 112156739, 112814707, 113073498, 113073498, 114140195, 114611284, 114623234, 114863840, 116332949, 119223830], '原创30000收藏': [85116042, 89940945, 97744623, 105681985, 107429786], 'leash': [85116042], '猫又小粥': [86429742, 95295577, 95578922, 97216102], '虚拟主播': [86429742, 93909005, 95578922, 97216102, 110436031, 111456249, 111723546, 111775230, 118402334], 'Hololive': [86429742, 93909005, 95295577, 95578922, 97216102, 110436031, 111456249, 111723546], '亜人系Vtuber': [86429742], 'virtual YouTuber': [86429742, 111456249, 111723546, 113866964, 118402334], 'hololive': [86429742, 93909005], 'Nekomata Okayu fanart': [86429742, 95578922], '肚脐': [86429742, 89455468, 105766640, 111456249, 115798216], '虚拟YouTuber 30000收藏': [86429742, 93909005], '商业绘图': [89455468, 113866964], '绘梦爱丽丝': [89455468], 'LiverCity': [89455468], '赤脚': [89455468, 95295577, 111774289, 112814707, 114540270, 115425149, 115439500, 115654142], 'sunrise': [89455468], '原创5000users加入书籤': [89455468], '女仆装': [89940945, 103085664, 113194644, 114256592], 'fox ears': [89940945, 101288368, 103085664, 110251260, 116362998], '风景': [92320191, 115113274, 117130134], 'background': [92320191, 115113274], '云': [92320191], 'Cloud': [92320191], 'sky': [92320191, 117130134], 'landscape painting': [92320191], 'sunset': [92320191, 92320191], '日落': [92320191], 'girl': [92320191], '噶呜·古拉': [93909005], 'HololiveEN': [93909005, 111456249, 111723546, 111775230], '水手服': [93909005, 109403472, 114140195, 114719663], 'GawrGura': [93909005], '没穿内裤': [93909005, 95295577], '尻神样': [93909005, 95295577, 95578922, 108868627], 'バーチャルYoutuber': [95295577], 'Virtual YouTuber 10000+ bookmarks': [95295577, 95578922, 97216102, 111775230], 'captivating ass': [95295577], '内衣': [95578922, 97216102], '丁字裤': [95578922], '极上女体': [95578922], '胖次': [95578922, 97216102, 103085664, 103854857, 109403472, 112814707, 113827401, 114256592, 115654142, 115942744, 116321773, 117717637, 118839253, 119006438], '向上看': [97216102], 'エロおにぎり': [97216102], '魅惑的乳沟': [97216102], '才女のお世話': [97744623], '黑长直': [97744623], 'blazer': [97744623], '格子裙': [97744623], '长发': [97744623], 'ルーズサイドテール': [97744623], '显性巨乳': [97820948], '泪痣': [97820948], '女高中生': [97820948, 114334547], '樱花': [97820948], '黑裤袜': [97820948, 118839253], 'kayoko(fukuro)': [97820948], 'commission': [97834342, 109875858], '深雪（碧蓝航线）': [101288368], '女仆': [101288368, 112985310, 113194644, 113382108], '碧蓝航线1000users加入书籤': [101288368, 103085664, 112814707, 115425149, 115555168, 115652323, 115795804, 118839253], '碧蓝档案': [102142513, 110251260, 110579259, 111699066, 111723655, 112605561, 114659963, 114979713, 115942744, 115951373, 116332949], 'Kuda Izuna': [102142513, 110251260, 116332949], 'ブ ルアカ': [102142513, 111699066, 111723655, 114659963, 114979713, 115951373, 116332949], '泳装': [102142513, 111775230, 113866964], 'Blue Archive 5000+ bookmarks': [102142513, 114659963, 115951373], '脱内裤': [102142513], '比基尼': [102142513, 112156739], '着袜足底': [103085664, 107427921, 113866964, 113874156, 115034087, 116321773, 118839253], '霞(碧蓝航线)': [103085664], '兔糖糖': [103833240], '小萝卜兔糖妮': [103833240], 'oc': [103833240, 116321773], '原创角色': [103833240, 116321773], '兔耳': [103833240], '圣诞节': [103833240, 103854857, 114540270], '魅惑的大腿': [103833240], '露内裤': [103833240, 103854857, 109403472, 114256592], '原创20000收藏': [103833240], '可爱': [103854857, 108868627, 112043080, 114611284, 114623234, 115795804], 'Santa cosplay': [103854857], 'xmas': [103854857], '银发': [105681985, 112706079], 'cat and girl': [105681985], 'shortcake': [105681985], 'ピンクネイル': [105681985], 'Ilu Fluor': [105766640], '樱田诗露': [105766640, 112156739, 114611284], '猫崎星衣藍': [105766640], '星村ほたる': [105766640], 'Sakurada Hane': [106510956], 'ハネ絵': [106510956], 'HaneArt': [106510956], 'one-finger selfie': [106510956], '手套': [106510956, 106510956, 112706079], '自拍': [106510956], 'Genshin Impact': [107427921], 'GenshinImpact': [107427921], '芭芭拉': [107427921], '芭芭拉（原神）': [107427921], '衣服湿透': [107427921], 'Barbara': [107427921], '美甲': [107427921], '原神10000收藏': [107427921], 'showgirl': [107429786], '珍珠奶茶': [107429786], 'nail': [107429786], 'headband': [107429786], '夏宮らむね': [108868627], 'skeb': [108868627, 114611284, 114623234], 'ジャージエプロン': [108868627], '运动服女仆': [108868627], 'bubble butt': [108868627], 'pink panties': [109403472], '原创1000users加入书籤': [109403472, 112706079, 113328969, 113833851, 117130134, 117717637], '露胸罩': [109403472], 'たこ焼き': [109875858], 'school uniform': [109875858], 'shoe lockers': [109875858], '剥ぎ取りそうなビキニ': [110251260], '初音未来': [110359091, 112043080], 'VOCALOID': [110359091, 112043080], '内裤': [110359091, 119006438], '妹妹': [110407870, 110617751, 112603909, 112985310, 113194644, 113382108, 115393059], 'ほっぺがもちもちな妹ちゃん': [110407870, 110617751, 112603909, 112985310, 113194644, 113382108, 115393059], 'Mococo Abyssgard': [110436031, 111456249, 111723546, 111775230], 'Fuwawa Abyssgard': [110436031, 111723546], 'FUWAMOCO': [110436031, 111456249, 111723546, 111775230], 'Virtual YouTuber 1000+ bookmarks': [110436031, 114719663], 'doodle': [110579259], 'BlueArchive': [110579259, 111699066, 111723655, 115942744], '鬼灭之刃': [110579259], '亚德（碧蓝航线）': [110579259], '贝奇（碧蓝航线）': [110579259], 'Last Origin': [110579259], 'Mika Misono': [110579259], '龙华妃咲': [110579259], 'sleeping face': [110617751], 'holoAdvent': [111456249], 'Virtual YouTuber 5000+ bookmarks': [111456249, 111723546], '100 Day Challenge': [111699066], 'Takanashi Hoshino': [111699066], 'gym uniform': [111699066], '灯笼裤': [111699066], 'Blue Archive 10000+ users': [111699066, 114659963], 'popsicle': [111699066], '腋下': [111723546], '杏山和纱': [111723655], '蛋糕': [111723655], 'loli': [111774289, 112814707, 114256592, 115034087, 115654142], '脚指': [111774289, 113874156, 115425149, 115439500], 'Hatsuzuki (Azur Lane)': [111774289], '葉月の恋模様': [111774289], '碧蓝航线5000收藏': [111774289, 114256592, 115654142], '眼睛爱心': [111775230], '抱膝坐': [111775230], 'bunny ears': [111903995], '连衣裙': [111903995], 'もちよの部屋': [112043080], '胸夹领带': [112043080], '双马尾': [112043080], 'うるせえ俺が髪絵師だフォロー しろ': [112043080], 'vocaloid': [112043080], 'HatsuneMiku': [112043080], 'cheeks': [112603909], 'もちもちほっぺ': [112603909], 'original character': [112605561], '星空列车与白的旅行': [112660921], 'カルハ': [112660921], '星白': [112660921], 'doujin game': [112660921], '哥特萝莉': [112706079], '欧派': [112706079, 113827401, 113833851, 114334547, 114540270, 114863840, 116332949, 119006438], '大 腿': [112706079, 112814707, 113833851, 114140195, 114719663, 114863840, 115439500, 115942744, 119223830], 'lamp': [112706079], '白丝袜': [112814707], 'Whydah (Azur Lane)': [112814707], '萝莉': [113073498, 113866964, 114611284, 114623234, 115425149, 115439500, 115555168], '地雷系': [113073498], 'harness': [113073498], 'rainy season': [113073498], 'yuri': [113328969], '百奇日': [113328969], 'holding hands with fingers interlocked': [113328969], '百合1000收藏': [113328969], 'lesbian kiss': [113328969], '马尾': [113389072], ' 麦当劳': [113389072], '藍羽ミナ': [113827401], '腹部': [113827401, 118402334], 'long green hair': [113833851], 'I want to lick your thighs': [113833851, 114334547], '黎歌Neeko': [113866964], 'vup': [113866964], '白筒袜': [113866964], 'sandals': [113866964], '東方Project': [113874156], '芙兰朵露・斯卡蕾特': [113874156], 'Scarlet Devil Mansion': [113874156], '蕾米莉亚·斯卡蕾特': [113874156], '流れるような自殺': [113874156], '弗兰德尔（碧蓝航线）': [114256592], '蛮啾（碧蓝航线）': [114256592, 115425149, 115555168, 115798216], 'R-18': [114327716], '憋尿': [114327716], 'holding the crotch': [114327716], 'elevator': [114327716], 'Skeb': [114327716], 'inner color': [114334547], '长筒袜': [114334547], 'plump thighs': [114334547], '过膝袜': [114334547], 'plump cleavage / cleavage': [114334547], '贫乳': [114358322], 'green hair': [114540270, 117717637, 119006438], 'angel': [114540270, 117717637, 119006438], '鸭子坐': [114540270], 'naughty knot': [114540270], '白发': [114611284, 114863840], '毛茸茸': [114611284, 115795804], 'aqua': [114623234], '斜め 後ろハイアングル': [114623234], 'beautiful girl': [114659963, 115034087], 'Konuri Maki (Camp)': [114659963, 114979713], 'Blue Archive 1000+ users': [114659963], 'Maki Konuri': [114659963, 114979713], 'Ichigori Ena': [114719663], 'animal ears': [114719663, 115942744], '创可贴': [114863840], 'New Year': [114863840], 'Arknights': [115034087], 'White silk pantyhose': [115034087], '同人创作': [115034087], '明日方舟': [115034087], 'Warmy': [115034087], 'original tag for fanmade works': [115034087], '涂鸦': [115113274], 'original': [115113274], 'fantasy': [115113274], '夕阳': [115113274, 117130134], '奇幻': [115113274], "boyfriend's shirt": [115393059, 119006438], 'spiral eyes': [115393059], 'thermometer': [115393059], '龙武（碧蓝航线）': [115425149, 115555168, 115652323, 115654142, 115795804, 115798216], '美甲（脚趾）': [115425149], '裸足脚底': [115425149, 115439500, 119006438], 'キュミ': [115439500], '美腿陷阱': [115439500], '热裤': [115439500], '屁股': [115439500, 118839253], '虎贲（碧蓝航线）': [115555168, 115652323, 115654142, 115798216], 'Fei Yuen (Azur Lane)': [115555168, 115654142], '巫月しお': [115610640], 'ルルベル': [115610640], '原作': [115652323], 'AzurLane': [115795804], '龙娘': [115795804], '卧槽好可爱': [115795804], '姐妹': [115798216], '碧蓝航线100收藏': [115798216], '虎舞迎春': [115798216], 'Kuromi Serika (New Year)': [115942744], 'Kuromi Serika': [115942744], 'miko': [115942744], '掀起裙子': [115942744], 'White that give sense of relief': [115942744], 'Onikata Kayoko': [115951373], 'Happy New Year 2024': [116321773], 'happy new year': [116321773], 'year of the dragon': [116321773], '黑丝袜': [116321773], '魅魔': [116362998], '拥抱': [117717637], 'アクガキコア': [118402334], '异色瞳': [118402334], 'idolES': [118402334], 'idolcorp': [118402334], 'Long Island (Azur Lane)': [118839253], '真空': [118839253], '崩坏：星穹铁道': [118880286], 'Honkai: Star Rail': [118880286], '流萤（星穹铁道）': [118880286], 'Firefly': [118880286], 'headdress': [118880286], '崩坏：星穹铁道10000收藏': [118880286], '星（星穹铁道）': [118880286], '下着ワイシャツ': [119006438], '破损的丝袜': [119223830]}


logger.info('数据操作全部完成')
logger.info('进入交互模式，键入exit以退出')

while True:
    print('>>>', end = '')
    search = input()
    if search == 'exit':
        break
    else:
        keys = list(map_result.keys())
        target_keys = get_close_matches(search, keys, n = 8, cutoff = 0.1)
        if len(target_keys) > 1:
            print(f'可能的结果: {target_keys}')
            target_key = input('请选择其中一个结果: ')
            while not target_key in target_keys:
                print('未匹配, 请重新选择: ')
            print(f'pids: {map_result[target_key]}')
        else:
            target_key = target_keys[0]
            print(f'pids: {map_result[target_key]}')

logger.info('程序执行完成')